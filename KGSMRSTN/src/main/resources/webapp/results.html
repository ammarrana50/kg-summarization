<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Force Layout with labels on edges</title>
	
<link rel="apple-touch-icon" sizes="180x180" href="includes/images/icons/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="includes/images/icons/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="includes/images/icons/favicon/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
<!-- Bootstrap CSS -->

<link href="includes/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="includes/vendor/jquery/jquery-3.2.1.min.js"></script>
<script src="includes/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<style type="text/css">
    .nodelabel {
        color:red;
    }
</style>
</head>
<body>

<script type="text/javascript">

    
    var dataset = {nodes:[],edges:[]};
    var nodeIds = [];

    function updateGraph(dataset) {
        

        var w = 1000;
        var h = 600;
        var linkDistance=200;

        var colors = d3.scale.category10();
        var svg = d3.select("body").append("svg").attr({"width":w,"height":h});

        var force = d3.layout.force()
            .nodes(dataset.nodes)
            .links(dataset.edges)
            .size([w,h])
            .linkDistance([linkDistance])
            .charge([-500])
            .theta(0.1)
            .gravity(0.05)
            .start();

    

        var edges = svg.selectAll("line")
        .data(dataset.edges)
        .enter()
        .append("line")
        .attr("id",function(d,i) {return 'edge'+i})
        .attr('marker-end','url(#arrowhead)')
        .style("stroke","#ccc")
        .style("pointer-events", "none");

        
        var nodes = svg.selectAll("circle")
        .data(dataset.nodes)
        .enter()
        .append("circle")
        .attr({"r":function(d){return d.size;}})
        .style("fill",function(d,i){return colors(i);})
        .call(force.drag)


        var nodelabels = svg.selectAll(".nodelabel") 
        .data(dataset.nodes)
        .enter()
        .append("text")
        .attr({"x":function(d){return d.x;},
                "y":function(d){return d.y;},
                "class":"nodelabel"})
        .text(function(d){return d.name;});

        var edgepaths = svg.selectAll(".edgepath")
            .data(dataset.edges)
            .enter()
            .append('path')
            .attr({'d': function(d) {return 'M '+d.source.x+' '+d.source.y+' L '+ d.target.x +' '+d.target.y},
                'class':'edgepath',
                'fill-opacity':0,
                'stroke-opacity':0,
                'fill':'blue',
                'stroke':'red',
                'id':function(d,i) {return 'edgepath'+i}})
            .style("pointer-events", "none");

        var edgelabels = svg.selectAll(".edgelabel")
            .data(dataset.edges)
            .enter()
            .append('text')
            .style("pointer-events", "none")
            .attr({'class':'edgelabel',
                'id':function(d,i){return 'edgelabel'+i},
                'dx':80,
                'dy':0,
                'font-size':10,
                'fill':'#aaa'});

        edgelabels.append('textPath')
            .attr('xlink:href',function(d,i) {return '#edgepath'+i})
            .style("pointer-events", "none")
            .text(function(d,i){return d.label});


        svg.append('defs').append('marker')
            .attr({'id':'arrowhead',
                'viewBox':'-0 -5 10 10',
                'refX':25,
                'refY':0,
                //'markerUnits':'strokeWidth',
                'orient':'auto',
                'markerWidth':10,
                'markerHeight':10,
                'xoverflow':'visible'})
            .append('svg:path')
                .attr('d', 'M 0,-5 L 10 ,0 L 0,5')
                .attr('fill', '#ccc')
                .attr('stroke','#ccc');
        

        force.on("tick", function(){

            edges.attr({"x1": function(d){return d.source.x;},
                        "y1": function(d){return d.source.y;},
                        "x2": function(d){return d.target.x;},
                        "y2": function(d){return d.target.y;}
            });

            nodes.attr({"cx":function(d){return d.x;},
                        "cy":function(d){return d.y;}
            });

            nodelabels.attr("x", function(d) { return d.x; }) 
                    .attr("y", function(d) { return d.y; });

            edgepaths.attr('d', function(d) { var path='M '+d.source.x+' '+d.source.y+' L '+ d.target.x +' '+d.target.y;
                                            //console.log(d)
                                            return path});       

            edgelabels.attr('transform',function(d,i){
                if (d.target.x<d.source.x){
                    bbox = this.getBBox();
                    rx = bbox.x+bbox.width/2;
                    ry = bbox.y+bbox.height/2;
                    return 'rotate(180 '+rx+' '+ry+')';
                    }
                else {
                    return 'rotate(0)';
                    }
            });
        });
    }


    
    $.getJSON("output.json", function(data) {
        $.each(data, function(subject, typeList) {
        
            if(nodeIds.indexOf(subject) == -1) {
                uriParts = subject.split('/');
                // inserting subject nodes
                dataset.nodes.push({
                    id: subject,
                    name: uriParts[uriParts.length-1],
                    size: 15,
                    color: "#"+((1<<24)*Math.random()|0).toString(16)
                });
                nodeIds.push(subject);
            }
            
            $.each(typeList, function(type, objectList) {
                relType = type.split('/');
                $.each(objectList, function(index, object) {
                
                // inserting object nodes and their edges

                if(nodeIds.indexOf(object.value) == -1) {
                uriParts = object.value.split('/');
                // inserting subject nodes
                dataset.nodes.push({
                    id: object.value,
                    name: uriParts[uriParts.length-1],
                    size: 30,
                    color: "#"+((1<<24)*Math.random()|0).toString(16)
                });
                nodeIds.push(object.value);
                }
                dataset.edges.push({
                    id: 'e_' + nodeIds.indexOf(subject) + "_" + nodeIds.indexOf(object.value),
                    label: relType[relType.length-1],
                    relType: type,
                    source: nodeIds.indexOf(object.value),
                    target: nodeIds.indexOf(subject),
                    size: 1,
                    color: '#ccc'
                });
                });
            });
        });

        updateGraph(dataset);
    });


 
    

</script>

</body>
</html>